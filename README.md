![Group 27](https://github.com/user-attachments/assets/6c05aa48-92a3-409b-af24-1945a17d6f42)

### **Back-End Developer**                        
---
- 개발: 2024.07 ~ 2024.12
- 개발 인원: 백엔드 개발 1명, 프론트 엔드 개발 1명, AI 모델 개발 2명

### 🛠 기술 스택

---
- Spring, Spring Boot, Spring Batch, Spring Data JPA, MySQL
- Git, Docker, AWS EC2, GitHub Actions

### 📖 서비스 내용

---

- 다양한 검색 조건으로 130만 건의 서울시 아파트 매매 정보와 이상 거래 여부를 손쉽게 확인
- 아파트 실거래 상세 정보와 AI 모델의 예측 거래가를 조회
- 최근 1년간의 실거래가와 AI 예측 가격을 그래프로 시각화하여 비교 분석 및 확인

### 🎛️ 시스템 아키텍쳐

---
![budda](https://github.com/user-attachments/assets/6bbdfee3-8502-49c7-8836-f9ab0e8ab3bb)

### 🙋‍♂️ 역할

---

1. **아파트 실거래가 데이터 수집 및 데이터베이스 저장**
    
    [**국토교통부의 아파트 매매 실거래가 API**](https://www.data.go.kr/data/15126469/openapi.do#/API%20%EB%AA%A9%EB%A1%9D/getRTMSDataSvcAptTrade)를 활용하여 **2006년부터 현재까지**의 **서울시 아파트 실거래 데이터**를 데이터베이스에 저장하는 배치 프로그램을 구현했습니다.
    
    - **구**에 해당하는 엔티티를 배치 시작 시에 CustomCacheRepository에 **캐싱**하였습니다. 이 접근법을 통해 **83,377개 데이터**를 저장하는 데 걸리던 시간을 **2분 6초**에서 **54.577초**로 단축했습니다.
    - **API 호출**과 **데이터 읽기 로직**을 처리하기 위해 `ItemStreamReader`를 구현했습니다. **API 요청 성공** 시 `ExecutionContext`를 활용하여 관련 **페이지 정보** **저장**하고 **업데이트**함으로써,  배치 작업이 **중단되는 상황이** 생기더라도 **재시작** 시 **누락 없이 저장**할 수 있었습니다.
    - **시·구 코드**를 **Job 파라미터**로 설정하여 각 **구에 해당하는 데이터**만 수집하도록 설계했습니다. 이를 통해 구 단위로 데이터를 처리하며 **중복 저장을 방지**했습니다.
2. **좌표 저장**
카카오 API를 활용해 각 **실거래 아파트 정보**를 담고 있는 엔티티에 **좌표 데이터를 저장**하는 기능을 구현했습니다. 아래의 방식으로 **83,377개 데이터**를 처리하는 데 **20분 530초** 걸리던 작업 시간을 **34.330초**로 대폭 단축했습니다.
    - 기존의 `JpaPagingItemReader` 대신 NoOffset 방식을 적용한 ItemReader를 사용하여 약 135,000개의 데이터를 읽는 속도를 기존 1분에서 24초로 단축했습니다. 이를 통해 대략 60%의 성능 향상을 달성할 수 있었습니다.
    - **동일한 주소**에 대해서는 항상 **동일한 좌표**를 반환하므로, **동일한 주소**는 **API 호출**을 **생략**하고 **캐싱된 좌표를 반환**하도록 설계했습니다. 이를 통해 **불필요한 API 요청을 줄였습니다.**
    - **매 Chunk**마다 최대 **1000개의 HTTP 요청**이 발생할 수 있어, **HTTP 통신 대기 시간을 최소화**하기 위해 `ThreadPool`을 생성하여 병렬 처리하도록 설계했습니다. 이 과정에서 `poolSize`를 **5 이상**으로 설정하면 **과도한 API 요청**으로 인해 **HTTP 429(Too Many Requests)** 에러가 발생하는 문제가 있어, `poolSize`를 **4**로 조정하여 안정적으로 처리하도록 구현했습니다.
    - **AsyncProcessor**로부터 받은 결과 데이터들의 작업이 끝날 때까지 **대기**한 후, **유효한 좌표**만 **필터링**하여 처리하도록 했습니다. **좌표 데이터**를 데이터베이스에 **효율적으로** 저장하기 위해 **JDBC Execute Batch**를 사용했으며, **여러 개의 쿼리**를 **한 번**에 묶어서 데이터베이스로 전송함으로써 **Database I/O 작업**을 **최소화**했습니다. 이 과정에서 [**카카오페이 기술 블로그**](https://tech.kakaopay.com/post/spring-batch-performance/#%EB%B3%91%EB%A0%AC-%EC%B2%98%EB%A6%AC%EB%A1%9C-http-%ED%86%B5%EC%8B%A0-%EB%8C%80%EA%B8%B0-%EC%8B%9C%EA%B0%84-%EC%B5%9C%EC%86%8C%ED%99%94)를 참고하였습니다.
3. **아파트 실거래가 데이터 조회**
    
    데이터베이스에 저장된 아파트 실거래 데이터를 **다양한 필터링 조건**과 **정렬 조건**을 활용하여 원하는 데이터를 조회할 수 있도록 구현했습니다.
    
    - **Join 및 검색 조건**에 사용되는 컬럼에 적절한 **인덱스**를 설정하고, **Covering Index** 방식을 **응용**하여 조회에 **필수적인 ID만 우선적으로 추출**한 뒤, 이를 기반으로 **IN Query**를 통해 데이터를 조회하도록 설계했습니다. 이 과정에서 ID만을 가져오는 쿼리의 **실행 계획**이 **인덱스**만을 활용하는 방식(**Using index**)이 주가 되도록 변경된 것이 주요 **성능 개선 요인**이 되었습니다. 이는 약 **50%**의 **성능 개선** 효과를 가져왔습니다.
    - **페이지네이션** 시 **COUNT 쿼리**를 실행할 때, **정규화**가 잘 이루어지지 않아 **쿼리 수행 시간**이 오래 걸리는 문제가 있었습니다. 이에 **실시간 데이터 적재**가 없는 데이터를 사용하는 **시스템의 특성**을 고려하여, **동일한 조건**으로 요청된 **COUNT 값**을 **클라이언트 영역**에 저장하고 **반복 요청** 시 이를 **재사용**하도록 설계했습니다. 이를 통해 **추가적인 COUNT 쿼리 요청을 최소화**하여 **데이터베이스 부하**를 줄이고, **성능**을  **향상**시킬 수 있었습니다.

### 🧐 느낀 점

---

아파트 정보를 정규화하지 못한 점이 가장 아쉬웠습니다. [**국토교통부의 공동주택 단지 목록제공 API**](https://www.data.go.kr/data/15057332/openapi.do)를 활용해 아파트 정보를 먼저 저장하고, 이후 [**아파트 매매 실거래가 API**](https://www.data.go.kr/data/15126469/openapi.do#/API%20%EB%AA%A9%EB%A1%9D/getRTMSDataSvcAptTrade)를 통해 거래 금액과 거래 일자 등의 실거래 내역을 저장하려 했습니다. 하지만 E편한세상과 이편한세상처럼 두 API에서 제공하는 아파트 이름이 불일치하는 경우가 많았고, 실거래가 API에서는 아파트 이름 없이 동 정보만 표시된 경우도 많아 정규화를 완료하지 못했습니다.

130만 개의 데이터는 많은 양이 아닐 수 있지만, 인덱스 설정을 통해 성능을 크게 개선할 수 있었습니다. 인덱스 설정 전에는 30초가 걸리던 쿼리가 설정 후에는 1초 이내로 단축되었습니다. 또한, HTTP API 응답 시간을 줄이기 위해 도입한 캐싱과 병렬 처리는 작업 속도 향상에 매우 효과적이었습니다.

이번 경험을 통해 인덱스 설정과 같은 기본적인 최적화 작업이 얼마나 중요한지 깨달을 수 있었고 최적화 과정을 거쳤음에도 불구하고, 더욱 조회 성능을 개선하기 위해 기존 프로젝트를 기반으로 [**CQRS 패턴을 도입한 프로젝트**](https://github.com/naver0504/enhance-comprehensive-design)를 진행했습니다.

### 👀 서비스 화면
---
![image](https://github.com/user-attachments/assets/fd3044ed-f3ea-4641-bcbe-305b23ddd86c)
![image (1)](https://github.com/user-attachments/assets/a6ead61b-1819-4938-9e0b-b938e07388d8)

